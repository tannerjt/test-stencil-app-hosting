import{r as e,c as t,h as i,F as s,H as r,g as o}from"./p-a7bcab11.js";import{b as a}from"./p-fd260f2d.js";import{i as n}from"./p-d8201573.js";import{d as h}from"./p-5cd57599.js";import{c as l}from"./p-59d5148d.js";import{C as c}from"./p-1fde1b24.js";import{watch as d}from"@arcgis/core/core/watchUtils.js";import p from"@arcgis/core/layers/GraphicsLayer.js";import g from"@arcgis/core/widgets/Sketch/SketchViewModel.js";import u from"@arcgis/core/Graphic.js";import{project as f}from"@arcgis/core/geometry/support/webMercatorUtils.js";import b from"@arcgis/core/geometry/Polygon.js";import m from"@arcgis/core/geometry/Geometry.js";import y from"@arcgis/core/geometry/Extent.js";import{buffer as w}from"@arcgis/core/geometry/geometryEngine.js";import{l as v}from"./p-c57d2d2f.js";import"./p-dfe5a97d.js";import"@arcgis/core/kernel.js";var C;!function(e){e.START="start",e.ACTIVE="active",e.COMPLETE="complete",e.CANCEL="cancel"}(C||(C={}));const x=["select","point","polyline","polygon"],E={select:{icon:"select"},point:{icon:"pin"},polyline:{icon:"freehand"},polygon:{icon:"freehand-area"}};let G=class{constructor(i){e(this,i),this.arcgisHubMapDrawGraphicsChange=t(this,"arcgisHubMapDrawGraphicsChange",7),this.arcgisHubMapDrawGraphicsClear=t(this,"arcgisHubMapDrawGraphicsClear",7),this.arcgisHubMapDrawSelect=t(this,"arcgisHubMapDrawSelect",7),this.arcgisHubMapPopoverOpen=t(this,"arcgisHubMapPopoverOpen",7),this.arcgisHubMapPopoverClear=t(this,"arcgisHubMapPopoverClear",7),this.hubTelemetry=t(this,"hubTelemetry",7),this.mode="hybrid",this.tools=x,this.color=[0,0,0],this.resetOnDisconnect=!0,this.bottomOffset=0,this.topOffset=0,this.handles=[],a(this,"applyFilter","cancelEdits","clearFilter","deleteDrawing","handleSetBufferWidgetRef","handleSketchOnCreate","handleSketchOnUpdate","handleViewClick","handleViewExtentChange","handleViewPointerMoveOrDown","renderPrimaryOptions","renderEditOptions","renderEditingOptions","setPanelHeight","startEditing","saveEdits","setOptionsEl")}async componentWillLoad(){const{el:e}=this;this.intl=await n.loadIntlForComponent(e),this.createGraphicsLayers(),await this.connectViewModel(),this.addWatchHandles(),this.setViewPosition(),v()}connectedCallback(){this.addWatchHandles()}disconnectedCallback(){this.resetOnDisconnect&&this.reset(),this.removeWatchHandles()}handleMapDrawFilter(e){const{hubTelemetry:t,isFiltered:i}=this,{detail:{graphics:[s],save:r}}=e;if(s&&r&&i){const{geometry:{type:e}}=s;t.emit(Object.assign(Object.assign({},h.dictionary.category.interaction.action.search.label.filter),{details:l(e)}))}}handleWidgetSelected(e){const{activeTool:t,isEditing:i}=this,{target:s}=e,{icon:r}=s,o="minus-circle"===r?t:Object.entries(E).find((([,e])=>e.icon===r))[0];"select"!==o?this.reset():i&&this.cancelEdits(),this.activeTool=t===o?void 0:o,this.open=!1}handleWidgetDrawBufferChanged(e){const{detail:t}=e;this.bufferDetails=t}handleWidgetDrawBufferReset(){const{bufferGraphicsLayer:e}=this;e&&(this.bufferDetails=void 0,e.removeAll())}handleWidgetDrawBufferClosed(){this.bufferPanelVisible=!1}handleWidgetPanelToggled(e){const{target:t,detail:i}=e,{bufferWidgetEl:s}=this;t===s||i?t!==s||i||setTimeout((()=>{this.setPanelHeight()}),0):this.bufferPanelVisible=!1}handleActiveToolChange(e,t){const{hubTelemetry:i,sketchViewModel:s,isEditing:r}=this;s&&(s.cancel(),e&&"select"!==e&&!r?s.create(e):e||(this.isEditing=!1)),i.emit(Object.assign(Object.assign({},h.dictionary.category.interaction.action[e?"enable":"disable"].label["select"===e?"select":"draw"]),{details:l(e||t)}))}handleGraphicsChange(){const{geometry:e,bufferWidgetEl:t}=this;e?(this.addGeometryToGraphicsLayer(),this.startEditing()):(this.reset(),null==t||t.forceReset(),this.activeTool=void 0)}handleIsEditingChange(){const{isEditing:e}=this;e||(this.activeTool=void 0),this.setBufferPanelVisible()}handleIsFilteredChange(){const{isFiltered:e,graphicsLayer:{graphics:t}}=this,i=t.getItemAt(0);if(e&&i){const{geometry:{type:e}}=i;i.symbol=this[`${e}Symbol`]}this.setBufferPanelVisible()}handleViewChange(e,t){e&&e!==t&&(this.removeWatchHandles(),this.connectViewModel().then((()=>{this.addWatchHandles()})))}handleBufferDetailsChanged(){const{arcgisHubMapDrawGraphicsChange:e,bufferPolygonSymbol:t,graphicsLayer:i,bufferGraphicsLayer:s,bufferDetails:r,isEditing:o}=this,{graphics:a}=i,[n]=a,{graphics:h}=s;if(!r||!n)return;const{distance:l,unit:c}=r,d=w(null==n?void 0:n.geometry,l,c.split(" ").join("-"),!0),p=new u({geometry:d,symbol:t});s.removeAll(),s.add(p),e.emit({graphics:a.clone(),bufferGraphics:h.clone(),save:!o})}async forceReset(){this.reset()}async setActiveTool(e){this.activeTool=e}handleSetBufferWidgetRef(e){e&&(this.bufferWidgetEl=e)}createGraphicsLayers(){const{graphicsLayer:e,bufferGraphicsLayer:t}=this;p&&(e||(this.graphicsLayer=new p({elevationInfo:{mode:"on-the-ground"}}),this.addGeometryToGraphicsLayer()),t||(this.bufferGraphicsLayer=new p({elevationInfo:{mode:"on-the-ground"}})))}handleSketchOnCreate(e){const{state:t,graphic:i}=e,{activeTool:s,arcgisHubMapPopoverOpen:r,bufferGraphicsLayer:o,graphicsLayer:a,hubTelemetry:n,view:l}=this;t===C.START&&n.emit(h.dictionary.category.interaction.action.draw.label.start.details[s]),t===C.COMPLETE&&(l.map.reorder(a,99),l.map.reorder(o,100),this.isEditing=!1,this.activeTool=void 0,setTimeout((()=>{r.emit({geometry:null==i?void 0:i.geometry,view:l,render:this.renderPrimaryOptions})}),150),n.emit(h.dictionary.category.interaction.action.draw.label.complete.details[s]),this.disableEditOptions&&this.disablePrimaryOptions&&this.arcgisHubMapDrawGraphicsChange.emit({graphics:a.graphics.clone(),unsaved:!0})),t===C.CANCEL&&(this.isEditing=!1,this.activeTool=void 0)}handleSketchOnUpdate(e){const{state:t}=e,{arcgisHubMapPopoverClear:i,arcgisHubMapDrawGraphicsChange:s,graphicsLayer:{graphics:r},bufferGraphicsLayer:{graphics:o}}=this;t===C.ACTIVE&&(i.emit(),s.emit({graphics:r.clone(),bufferGraphics:o.clone()}),this.handleBufferDetailsChanged())}handleViewClick(e){const{activeTool:t,arcgisHubMapPopoverClear:i,hubTelemetry:s}=this;i.emit(),"select"===t?(s.emit(h.dictionary.category.interaction.action.select.label.content.details.selectTool),this.arcgisHubMapDrawSelect.emit(e)):s.emit(h.dictionary.category.interaction.action.select.label.content)}handleViewPointerMoveOrDown(e){const{view:t,graphicsLayer:i}=this;t.hitTest(e,{include:i}).then((e=>{var i,s,r;const{isFiltered:o,isEditing:a,arcgisHubMapPopoverOpen:n}=this;e.results.length&&n.emit(o&&!a?{geometry:null===(i=e.results[0].graphic)||void 0===i?void 0:i.geometry,view:t,render:this.renderEditOptions}:a?{geometry:null===(s=e.results[0].graphic)||void 0===s?void 0:s.geometry,view:t,render:this.renderEditingOptions}:{geometry:null===(r=e.results[0].graphic)||void 0===r?void 0:r.geometry,view:t,render:this.renderPrimaryOptions})}))}handleViewExtentChange(){const{arcgisHubMapPopoverClear:e}=this;e.emit()}handleToolsOpened(){this.open=!0,this.hubTelemetry.emit(h.dictionary.category.interaction.action.open.label.popover.details.options)}handleToolsClosed(){this.open=!1,this.hubTelemetry.emit(h.dictionary.category.interaction.action.close.label.popover.details.options)}async connectViewModel(){const{bufferGraphicsLayer:e,graphicsLayer:t,mode:i,sketchViewModel:s,view:r,pointSymbol:o,polygonSymbol:a,polylineSymbol:n}=this;r&&!s&&g&&(await r.when(),r.map.addMany([t,e]),this.sketchViewModel=new g({view:r,layer:t,defaultCreateOptions:{mode:i},updateOnGraphicClick:!1,polygonSymbol:a,polylineSymbol:n,pointSymbol:o}),d(r,"size",this.setPanelHeight))}addWatchHandles(){const{handles:e,sketchViewModel:t,view:i}=this;i&&d&&t&&e.push(i.on("pointer-down",this.handleViewClick),i.on(["pointer-move","pointer-down"],this.handleViewPointerMoveOrDown),d(i,"extent",this.handleViewExtentChange),t.on("create",this.handleSketchOnCreate),t.on("update",this.handleSketchOnUpdate))}removeWatchHandles(){const{handles:e}=this;e.forEach((e=>{e.remove()})),this.handles=[]}addGeometryToGraphicsLayer(){const{geometry:e,graphicsLayer:t,sketchViewModel:i}=this;if(!e||!t||!this.sketchViewModel)return;this.reset(),this.isFiltered=!0;const s=this.processGeometry(e),r=new u({geometry:s,symbol:i[`${s.type}Symbol`]});t.add(r)}applyFilter(){const{arcgisHubMapDrawGraphicsChange:e,arcgisHubMapPopoverClear:t,graphicsLayer:{graphics:i},bufferGraphicsLayer:{graphics:s}}=this;this.isFiltered=!0,e.emit({graphics:i.clone(),bufferGraphics:s.clone(),save:!0}),t.emit()}deleteDrawing(){const{graphicsLayer:{graphics:[e]},hubTelemetry:t,bufferWidgetEl:i}=this;if(!e)return;const{geometry:{type:s}}=e;t.emit(Object.assign(Object.assign({},h.dictionary.category.interaction.action.draw.label.delete.details[s]),{response:"Success"})),this.reset(),this.activeTool=void 0,null==i||i.forceReset()}clearFilter(){const{arcgisHubMapDrawGraphicsClear:e,hubTelemetry:t}=this;this.deleteDrawing(),e.emit(),t.emit(h.dictionary.category.interaction.action.search.label.filter.details.clear)}startEditing(){const{arcgisHubMapPopoverClear:e,graphicsLayer:{graphics:t},bufferGraphicsLayer:{graphics:i},hubTelemetry:s,sketchViewModel:r,geometryIsExtent:o}=this;e.emit(),this.isEditing=!0,this.cachedGraphics=t.clone(),this.cachedBufferGraphics=i.clone();const a=t.getItemAt(0);this.activeTool=a.geometry.type;let n="reshape",l=!0,c=!0;o&&(n="transform",l=!1,c=!1),r.update(t.getItemAt(0),{tool:n,enableRotation:l,toggleToolOnClick:c}),s.emit(h.dictionary.category.interaction.action.enable.label.draw.details.update)}cancelEdits(){const{arcgisHubMapPopoverClear:e,arcgisHubMapDrawGraphicsChange:t,cachedGraphics:i,cachedBufferGraphics:s,graphicsLayer:{graphics:r},bufferGraphicsLayer:{graphics:o},hubTelemetry:a}=this;i&&s&&(this.graphicsLayer.graphics=i.clone(),this.cachedGraphics=null,this.bufferGraphicsLayer.graphics=s.clone(),this.cachedBufferGraphics=null),this.isEditing=!1,e.emit(),t.emit({graphics:r.clone(),bufferGraphics:o.clone(),canceled:!0}),a.emit(h.dictionary.category.interaction.action.disable.label.draw.details.update)}saveEdits(){const{activeTool:e,arcgisHubMapDrawGraphicsChange:t,arcgisHubMapPopoverClear:i,graphicsLayer:{graphics:s},bufferGraphicsLayer:{graphics:r},hubTelemetry:o,sketchViewModel:a}=this;a.complete(),t.emit({graphics:s.clone(),bufferGraphics:r.clone(),save:!0}),i.emit(),this.isEditing=!1,o.emit(h.dictionary.category.interaction.action.draw.label.update.details[e]),this.open=!1}reset(){const{bufferGraphicsLayer:e,graphicsLayer:t,arcgisHubMapPopoverClear:i,bufferWidgetEl:s}=this;t&&e&&(this.isEditing=!1,this.isFiltered=!1,this.cachedGraphics=null,this.cachedBufferGraphics=null,this.geometryIsExtent=!1,this.geometry=null,t.removeAll(),e.removeAll(),i.emit(),null==s||s.forceReset())}processGeometry(e){const{view:t}=this;let i=e;return e.clone||(i="extent"===e.type?y.fromJSON(i):m.fromJSON(i)),"extent"===e.type?(this.geometryIsExtent=!0,i=b.fromExtent(i)):this.geometryIsExtent=!1,i.spatialReference!==t.spatialReference&&(i=f(i,t.spatialReference)),i}setBufferPanelVisible(){const{isEditing:e,isFiltered:t}=this;this.bufferPanelVisible=e||t}setPanelHeight(){const{bufferWidgetEl:e,view:{size:t,container:i}}=this;if(!e)return;const[s]=t;this.viewWidth=s;const{top:r,bottom:o}=i.getBoundingClientRect(),{top:a,bottom:n}=e.getBoundingClientRect();this.topOffset=a-r,this.bottomOffset=o-n}setViewPosition(){const{el:e}=this,t=e&&e.closest("arcgis-hub-map-widget-container");this.viewPosition=null==t?void 0:t.viewPosition}setOptionsEl(e){this.optionsEl=e}get pointSymbol(){const{color:e}=this;return{type:"text",color:[...e,.9],text:"î˜",font:{size:24,family:"CalciteWebCoreIcons"}}}get polylineSymbol(){const{lineStyle:e,color:t}=this;return{style:e,color:[...t,1],width:2,type:"simple-line"}}get polygonSymbol(){const{color:e,lineStyle:t}=this;return{type:"simple-fill",style:"solid",color:[0,0,0,0],outline:{style:t,color:[...e,1],width:2}}}get lineStyle(){const{isFiltered:e}=this;return e?"solid":"short-dash"}get bufferPolygonSymbol(){const{color:e}=this;return{type:"simple-fill",style:"cross",color:[...e,.1],outline:{style:"short-dash",color:[...e,1],width:2}}}get positionClass(){const{viewPosition:e}=this;if(e)return`hub-widget-draw ${e.split("-").join(" ")}`}get styles(){const{viewWidth:e,bottomOffset:t,topOffset:i,bufferPanelVisible:s}=this;return{"--view-width":`${e}px`,"--bottom-offset":`${t}px`,"--top-offset":`${i}px`,"--mobile-display":s?"flex":"none"}}renderPrimaryOptions(e="polygon"){const{disablePrimaryOptions:t}=this,r=this.intl.t(`filter.${e}`),o=this.intl.t("delete");return t?this.renderEditOptions():i(s,null,i("calcite-action",{icon:"selection-filter",onClick:this.applyFilter,text:r,"text-enabled":!0}),i("calcite-action",{icon:"trash",onClick:this.deleteDrawing,text:o,"text-enabled":!0}))}renderEditOptions(){const e=this.intl.t("update"),t=this.intl.t("delete");return i("calcite-action-pad",{"expand-disabled":!0,layout:"horizontal"},i("calcite-action",{icon:"pencil",onClick:this.startEditing,text:e}),i("calcite-action",{icon:"trash",onClick:this.clearFilter,text:t}))}renderEditingOptions(){const e=this.intl.t("cancel"),t=this.intl.t("save");return i(s,null,i("calcite-action",{icon:"undo",onClick:this.cancelEdits,text:e,"text-enabled":!0}),i("calcite-action",{icon:"check",onClick:this.saveEdits,text:t,"text-enabled":!0}))}renderDrawBuffer(){const{buffer:e,positionClass:t,handleSetBufferWidgetRef:s,bufferPanelVisible:r}=this;if(e)return i("arcgis-hub-map-widget-draw-buffer",{class:t,ref:s,visible:r})}renderDrawToolWidgets(e=!1){const{tools:t,activeTool:s}=this;return x.reduce(((r,o)=>t.includes(o)?[...r,i("arcgis-hub-map-widget-generic",{active:s===o,icon:E[o].icon,key:o,text:this.intl.t(o),textEnabled:e})]:r),[])}renderDrawingOptionsAction(){const{open:e,isEditing:t,activeTool:s,intl:r}=this,o=e||t;let a,n;return a=t?"pencil":s?E[s].icon:"pencil-mark-plus",n=r.t(t?"updating":e?"close":"open"),i("calcite-action",{active:o,icon:a,ref:this.setOptionsEl,text:n})}renderDrawingOptionsPopoverContent(){const{isEditing:e,open:t,activeTool:r,intl:o}=this;return e?i("calcite-action",{onClick:this.saveEdits,text:o.t("finish"),"text-enabled":!0}):i(s,null,this.renderDrawToolWidgets(!0),r&&t&&i("arcgis-hub-map-widget-generic",{icon:"minus-circle",text:o.t("stop"),"text-enabled":!0}))}renderCondensedDrawTools(){const{open:e,intl:t,optionsEl:r}=this;return i(s,null,this.renderDrawingOptionsAction(),this.renderDrawBuffer(),i("calcite-popover",{"auto-close":!0,"disable-pointer":!0,label:t.t("options"),offsetDistance:15,open:e,placement:"left-start",referenceElement:r},this.renderDrawingOptionsPopoverContent()))}renderDrawTools(){return i(s,null,this.renderDrawBuffer(),this.renderDrawToolWidgets())}render(){return i(r,{"data-element":"map-widget-draw",style:this.styles},this.condensed?this.renderCondensedDrawTools():this.renderDrawTools())}static get assetsDirs(){return["locales"]}get el(){return o(this)}static get watchers(){return{activeTool:["handleActiveToolChange"],geometry:["handleGraphicsChange"],isEditing:["handleIsEditingChange"],isFiltered:["handleIsFilteredChange"],view:["handleViewChange"],bufferDetails:["handleBufferDetailsChanged"]}}};(function(e,t,i,s){var r,o=arguments.length,a=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,s);else for(var n=e.length-1;n>=0;n--)(r=e[n])&&(a=(o<3?r(a):o>3?r(t,i,a):r(t,i))||a);o>3&&a&&Object.defineProperty(t,i,a)})([c({when(){return!this.disableEditOptions}})],G.prototype,"renderEditOptions",null),G.style=":host{display:block}.hub-widget-draw{min-width:none !important;max-width:none !important;padding:0px}arcgis-hub-map-widget-generic:nth-of-type(5){border-left-width:0px;border-right-width:0px;border-top-width:1px;border-bottom-width:0px;border-style:solid;border-color:var(--calcite-ui-border-1)}@media only screen and (min-width: 640px){.hub-widget-draw.top{position:absolute}.hub-widget-draw.top{width:25rem}.hub-widget-draw.top{padding:0px}.hub-widget-draw.right{right:100%}.hub-widget-draw.right{margin-right:1rem}.hub-widget-draw.left{left:100%}.hub-widget-draw.left{margin-left:1rem}.hub-widget-draw.bottom.left{margin-left:0.5rem}.hub-widget-draw.bottom.right{margin-right:0.5rem}}@media only screen and (max-width: 640px){.hub-widget-draw.top{position:absolute}.hub-widget-draw.top{z-index:50}.hub-widget-draw.top{padding:0px}.hub-widget-draw.top{top:calc(var(--top-offset) + var(--bottom-offset));width:calc(var(--view-width) + 1px);display:var(--mobile-display)}.hub-widget-draw.right{right:-1rem}.hub-widget-draw.left{left:-1rem}}";export{G as arcgis_hub_map_widget_draw}